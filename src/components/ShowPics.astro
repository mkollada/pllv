---
import { galleryItems, getImageSources } from '../data/gallery'

function shuffleWithVideoLimit<T extends { type: string }>(arr: T[]): T[] {
  const images = arr.filter((item) => item.type !== 'video')
  const videos = arr.filter((item) => item.type === 'video')

  // Shuffle both arrays
  function shuffleArray<T>(array: T[]): T[] {
    const a = [...array]
    for (let i = a.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1))
      ;[a[i], a[j]] = [a[j], a[i]]
    }
    return a
  }

  const shuffledImages = shuffleArray(images)
  const shuffledVideos = shuffleArray(videos)

  const result: T[] = []
  let imgIdx = 0,
    vidIdx = 0,
    consecutiveVideos = 0

  // Alternate filling, ensuring no more than two consecutive videos
  while (imgIdx < shuffledImages.length || vidIdx < shuffledVideos.length) {
    if (
      vidIdx < shuffledVideos.length &&
      consecutiveVideos < 2 &&
      (Math.random() < 0.5 || imgIdx >= shuffledImages.length)
    ) {
      result.push(shuffledVideos[vidIdx++])
      consecutiveVideos++
    } else if (imgIdx < shuffledImages.length) {
      result.push(shuffledImages[imgIdx++])
      consecutiveVideos = 0
    } else if (vidIdx < shuffledVideos.length) {
      // Only videos left but make sure not to break consecutiveVideos rule
      if (consecutiveVideos < 2) {
        result.push(shuffledVideos[vidIdx++])
        consecutiveVideos++
      } else {
        // If only videos left and already 2 videos, insert an image if any left
        // but if not (should not happen), break infinite loop
        break
      }
    }
  }
  return result
}

const shuffledItems = shuffleWithVideoLimit(galleryItems)
---

<div class="w-full max-w-full px-2 py-4 md:px-4 md:py-6">
  <div class="columns-1 gap-x-4 sm:columns-2 lg:columns-1" role="list">
    {
      shuffledItems.map((item) => (
        <figure class="group mb-4 overflow-hidden break-inside-avoid" role="listitem">
          {item.type === 'image' ? (
            (() => {
              const { src, srcset } = getImageSources(item.image.base)

              return (
                <div class="relative w-full overflow-hidden">
                  <img
                    src={src}
                    srcset={srcset}
                    sizes="(max-width: 768px) 90vw, 800px"
                    alt={item.image.alt}
                    loading="lazy"
                    decoding="async"
                    class="w-full h-auto object-contain transition-transform duration-200 group-hover:scale-[1.02]"
                  />
                </div>
              )
            })()
          ) : (
            <div class="relative w-full overflow-hidden pt-[56.25%]">
              <iframe
                src={item.embedUrl}
                title={item.caption ?? 'Embedded video'}
                class="absolute inset-0 h-full w-full"
                loading="lazy"
                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                allowfullscreen
              />
            </div>
          )}
        </figure>
      ))
    }
  </div>
</div>
